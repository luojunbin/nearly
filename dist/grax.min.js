!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],e):e(t["grax-react"]={},t.React)}(this,function(t,e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t},o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},a=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(r):void 0},s=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},u=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},c=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),f=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},h=function(){function t(e,r,i){n(this,t),this.name=e,this.state=i,this.isPending=!1,this.renderHandlers=[],this.dispatchers=r,this.getState=this.getState.bind(this),this.dispatch=this.dispatch.bind(this),this.syncDispatch=this.syncDispatch.bind(this)}return r(t,[{key:"getState",value:function(){return o({},this.state)}},{key:"initState",value:function(){var t=this;if("function"!=typeof this.dispatchers.init)throw Error("can not find 'init' of store: "+this.name);if(this.isPending)return null;var e,n=this.dispatchers.init(this.getState);return(e=n)&&"function"==typeof e.then?(this.isPending=!0,n.then(function(e){t.isPending=!1,t.syncDispatch(e)})):this.syncDispatch(n)}},{key:"link",value:function(t){this.renderHandlers.push(t)}},{key:"unlink",value:function(t){this.renderHandlers=this.renderHandlers.filter(function(e){return e!==t})}},{key:"dispatch",value:function(t){return Promise.resolve(t).then(this.syncDispatch)}},{key:"syncDispatch",value:function(t){var e=this;return null!==t&&(this.state=o({},this.state,t),this.renderHandlers.forEach(function(t){return t(i({},e.name,e.getState()))})),this.state}}]),t}(),l=new Function("\n  try {\n    return this === window;\n  } catch (e) {\n    return false;\n  }\n")(),p={};function y(t){return p[t]}var d={defaultPure:!1,beforeConnect:function(t){},beforeDispatch:function(t){var e=t.split("."),n=c(e,2),r=n[0],i=n[1],o=y(r);if(!o)throw Error("store '"+r+"' does not exist");var a=o.dispatchers[i];if(!a)throw Error("the module does not export function "+i);return{store:o,dispatcher:a}}};function v(t){for(var e=d.beforeDispatch(t),n=e.store,r=e.dispatcher,i=arguments.length,o=Array(i>1?i-1:0),a=1;a<i;a++)o[a-1]=arguments[a];var s=r.apply(n,[n.getState].concat(o));return n.dispatch(s)}var b=function(t){function e(){return n(this,e),u(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return s(e,t),r(e,[{key:"getChildContext",value:function(){return{graxState:this.props.state}}},{key:"render",value:function(){return this.props.children}}]),e}(e.Component);b.childContextTypes={graxState:function(){return null}},t.connect=function(t,i,c){var f=arguments.length>3&&void 0!==arguments[3]?arguments[3]:d.defaultPure;d.beforeConnect(t);var h=function(h){function l(e){n(this,l);var r=u(this,(l.__proto__||Object.getPrototypeOf(l)).call(this,e));return r.state={},r._isDirtyFromGrax=!1,r.store=[].concat(t).map(function(t){return y(t)}),r.setState=r.setState.bind(r),r}return s(l,h),r(l,[{key:"setState",value:function(t){var e=this;this._isDirtyFromGrax=!0,a(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"setState",this).call(this,t,function(){return e._isDirtyFromGrax=!1})}},{key:"initStore",value:function(){return this.store.map(function(t){return t.initState()})}},{key:"componentWillMount",value:function(){var t=this;this.store.forEach(function(e){t.context.graxState?t.state[e.name]=t.context.graxState[e.name]:(e.link(t.setState),e.state?t.state[e.name]=e.getState():e.initState())})}},{key:"shouldComponentUpdate",value:function(){return!f||this._isDirtyFromGrax}},{key:"componentWillUnmount",value:function(){var t=this;this.store.forEach(function(e){return e.unlink(t)})}},{key:"render",value:function(){return Object.keys(this.state).length!==this.store.length&&void 0!==c?c&&e.createElement(c):e.createElement(i,o({},this.props,{storeNames:t,store:o({},this.props.store,this.state)}))}}]),l}(e.Component);return h.displayName=function(t){return t.name||t.displayName||"Component"}(i)+"-"+t,h.isGraxComponent=!0,h.contextTypes={graxState:function(){return null}},h},t.getStore=y,t.registerStore=function(t,e){if(p[t])return p[t];var n=l&&window.__GRAX_STATE__?window.__GRAX_STATE__[t]:null;return p[t]=new h(t,e,n)},t.dispatch=v,t.dispatcher=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return v.bind.apply(v,[null].concat(e))},t.configure=function(t){for(var e in t)d.hasOwnProperty(e)&&(d[e]=t[e])},t.ContextProvider=b,t.prepare=function(t){var e=[].concat(t).map(function(t){var e=y(t);if(!e)throw new Error("Store '"+t+"' has not registered");return Promise.resolve(e.dispatchers.init(e.getState)).then(function(e){return i({},t,e)})});return Promise.all(e).then(function(t){return Object.assign.apply(Object,[{}].concat(f(t)))})},Object.defineProperty(t,"__esModule",{value:!0})});
